#!/usr/bin/env bash

# -u causes failure in activate: ADDR2LINE: unbound variable
# -x is just insanely noisy in the presence of conda
set -eo pipefail
stackdir=/opt/lsst/software/stack

SHELL=bash
export SHELL

MAMBA_ROOT_PREFIX="/opt/lsst/software/stack/conda"
export MAMBA_ROOT_PREFIX

# Never allow the installation to upgrade rubin_env.  Generally enforcing
# the pin is only needed for releases, where the current version may have
# moved ahead.

# mamba is ... going away in September 2025.
profdir=$stackdir/conda/etc/profile.d
if [ -f $profdir/mamba.sh ]; then
    mv $profdir/mamba.sh $profdir/mamba.sh.save
fi

source $stackdir/loadLSST.bash

rubin_env_ver=$(conda list rubin-env$ --json | jq -r '.[0].version')

# Refactor of rubin-env-rsp coming later to separate user packages from
# Lab environment packages.
set +e
conda install -y --no-update-deps "rubin-env-rsp==${rubin_env_ver}"
rc=$?
if [ ${rc} -ne 0 ]; then
    echo "Conda installation with --no-update-deps failed; retrying without"
    conda install -y "rubin-env-rsp==${rubin_env_ver}"
fi
set -e

# Structlog is a dependency of lsst-rsp.

conda install -y --no-update-deps structlog

# To make life easier at USDF we are adding three T&S packages that are not
# available from conda-forge.

conda install -y --no-update-deps -c lsstts ts-m1m3-utils ts-salobj ts-utils

# Try lsdb separately, do *not* say "--no-build-isolation" or
# "--no-update-deps"because we may need to pull in a newer pyarrow.
#
# It went into rubin-env-rsp in rubin-env 11, but we might need to rebuild an
# earlier image (e.g. 29.2.0).  Remove this after we're done with the 29.x.x
# series.
#
# Note that lsdb 0.6.4 is the version that is compatible with the rest of
# rubin-env 11, paired with hats 0.6.4.  That also needs cdshealpix 0.7.1.

have_lsdb=$(conda list --export | grep lsdb) || /bin/true
if [ -z "${have_lsdb}" ]; then
    echo "Doing separate installation of lsdb/hats 0.6.4"
    conda install -y lsdb=0.6.4 hats=0.6.4 cdshealpix=0.7.1
fi

# "--no-build-isolation" means we're also responsible for the dependencies
# not already provided by something in the conda env.  In this case,
# symbolicmode from lsst-rsp.
uv pip install --no-build-isolation \
    'lsst-rsp>=0.7.1' \
    'symbolicmode<3' \
    'jupyter_firefly_extensions>=0.15.0'

# Clean caches
conda clean -a -y -f
uv cache clean

# Turn off console in UI python.
source /usr/local/share/jupyterlab/venv/bin/activate
jupyter labextension disable @jupyterlab/console-extension
jupyter labextension lock @jupyterlab/console-extension

# Add spellchecker to UI python
uv pip install jupyterlab-spellchecker
