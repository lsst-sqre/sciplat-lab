#!/usr/bin/env bash
set -x
# -u causes failure in activate: ADDR2LINE: unbound variable
set -eo pipefail

get_latest_release_tag() {
    # Get the latest release tag from a git remote.
    
    # `git ls-remote --refs --tags` queries the remote for tags only.
    # `--sort="-version:refname"` sorts tags with the highest version first.
    # The greps throw away any alpha, beta, and rc tags.
    # Take the first thing that's left with `head -1`.
    # Discard the commit hash with `awk`.
    # Finally extract the tag from the reference with `sed`.
    # This is printed to stdout, and will be captured with $() in the caller.
    
    git ls-remote --sort="-version:refname" --refs --tags $1 | \
        grep -v alpha | grep -v beta | grep -v rc | \
        head -1 | awk '{print $2}' | sed -e 's|refs/tags/||' | tr -d '\n'
}

stackdir=/opt/lsst/software/stack

SHELL=bash
export SHELL

MAMBA_ROOT_PREFIX="/opt/lsst/software/stack/conda"
export MAMBA_ROOT_PREFIX

# Never allow the installation to upgrade rubin_env.  Generally enforcing
# the pin is only needed for releases, where the current version may have
# moved ahead.

# mamba is ... going away in September 2025.
profdir=$stackdir/conda/etc/profile.d
if [ -f $profdir/mamba.sh ]; then
    mv $profdir/mamba.sh $profdir/mamba.sh.save
fi

source $stackdir/loadLSST.bash

rubin_env_ver=$(conda list rubin-env$ --json | jq -r '.[0].version')

# Refactor of rubin-env-rsp coming later to separate user packages from
# Lab environment packages.
conda install -y "rubin-env-rsp==${rubin_env_ver}"

# These are the things that are not available on conda-forge.
# Note that we are not installing with `--upgrade`.  That is so that if
# lower-level layers have already installed the package, pinned to a version
# they need, we won't upgrade it.  But if it isn't already installed, we'll
# just take the latest available.  `--no-build-isolation` ensures that any
# source packages use C++ libraries from conda-forge.

# Nothing currently

# If we want --no-build-isolation to work in the next step, we have to
# install dependencies here.  uv and structlog are for SQuaRE packages,
# and the rest are for the T&S packages.  We use uv as a faster replacement
# for pip when installing the pip-installed packages below.

conda install -y authlib orjson pyside6 structlog sty uv

# These are Telescope and Site packages we're putting in the base build
# to make life easier for users at USDF.  Other users can just ignore them
# and they don't have a downside other than making the image somewhat larger.
#
# The T&S packages themselves are conda-packaged in the "lsstts" channel.
# But we cannot use these until the conda packages are compatible with
# current rubin-env and hence Python 3.13 (as of 17 Nov. 2025).
#
# When they are, we should be able to just run:
#   conda install -y -c lsstts ts-m1m3-utils ts-xml ts-utils ts-salobj
#
# T&S does not publish packages to pypi, so we have to install from their
# their git repositories directly.  We use the most recent tag for each repo,
# and install that, rather than a (possibly unreleased) HEAD.

tsrepos="ts_m1m3_utils ts_xml ts_utils ts_salobj"

ts_pip_urls=""
for r in ${tsrepos}; do
    url="https://github.com/lsst-ts/${r}"
    tag=$(get_latest_release_tag ${url})
    pip_url="git+${url}@${tag}"
    if [ -z "${ts_pip_urls}" ]; then
        ts_pip_urls=${pip_url}
    else
        ts_pip_urls="${ts_pip_urls} ${pip_url}"
    fi
done

# These are the things we use that are not conda-packaged.  That's the
# aforementioned T&S modules (until they are compatible with rubin-env),
# lsst-rsp, and jupyter_firefly_extensions.  Symbolicmode is a dependency
# of lsst-rsp and it is not conda-packaged.
uv pip install --no-build-isolation \
    ${ts_pip_urls} \
    'lsst-rsp>=0.7.1' \
    'symbolicmode<3' \
    'jupyter_firefly_extensions>=0.15.0'

# Turn off console
jupyter labextension disable @jupyterlab/console-extension
jupyter labextension lock @jupyterlab/console-extension

# Clean caches
conda clean -a -y -f
uv cache clean

# Turn off console in UI python too
source /usr/local/share/jupyterlab/venv/bin/activate
jupyter labextension disable @jupyterlab/console-extension
jupyter labextension lock @jupyterlab/console-extension

# Add spellchecker to UI python
uv pip install jupyterlab-spellchecker
