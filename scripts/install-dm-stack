#!/usr/bin/env bash
set -x

# -u makes lsstinstall fail, via conda ADDR2LINE: unbound variable.
set -eo pipefail

TAG=$1

SHELL=bash
export SHELL

MAMBA_ROOT_PREFIX="/opt/lsst/software/stack/conda"
export MAMBA_ROOT_PREFIX

stackdir=/opt/lsst/software/stack
sbt=https://raw.githubusercontent.com/lsst/shebangtron/main/shebangtron

mkdir -p $stackdir
cd $stackdir
curl -OL https://ls.st/lsstinstall
chmod u+x lsstinstall
# Alas, if we don't run it with bash, some of the activate scripts
# (rust and openmpi) fail, because they assume bash, not POSIX shell.
bash ./lsstinstall -T $TAG
source $stackdir/loadLSST.bash
for prod in $EUPS_PRODUCTS; do
    eups distrib install --no-server-tags "$prod" -t "$EUPS_TAG"
done

# Let's hope there are no spaces in filenames under $EUPS_PATH
echo "---cleanup---"
echo "Pre-cleanup ${stackdir} size:"
du -sm ${stackdir}
echo "ALL THE THINGS"
find ${EUPS_PATH} -print
echo "DONE WITH ALL THE THINGS"
for dirn in tests src .git; do
    victims=$(find ${EUPS_PATH} -name ${dirn} -type d -print)
    echo "'${dirn}' dirs to delete:"
    echo "${victims}"
    if [ -n "${victims}" ]; then
	rm -rf ${victims}
    fi
done
victims=$(find ${EUPS_PATH} \
	       \( -path "*doc/html" -o -path "*doc/xml" \) \
	  -type d -print)
echo "doc dirs to delete:"
echo "${victims}"
rm -rf ${victims}
echo "Pre-strip ${stackdir} size"
du -sm
# Do this the hard way
libs=$(find ${EUPS_PATH} -type f -name "*.so" -print)
echo "Libraries to strip: ${libs}"
for l in ${libs}; do
    strip -p --strip-unneeded "${l}" || echo "Strip failed"
done
exes=$(find ${EUPS_PATH} -type f -executable -print)
echo "Executables to strip: ${exes}"
for e in ${exes}; do
    strip -p --strip-unneeded "${e}" || echo "Strip failed"
done
echo "Post-cleanup ${stackdir} size:"
du -sm ${stackdir}
echo "---end cleanup---"

for product in lsst_distrib lsst_sitcom; do
    eups distrib install -t $TAG $product
done
curl -sSL $sbt | python
setup lsst_distrib

conda clean -a -f -y  # Not clear that -f is safe.
