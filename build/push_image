#!/bin/bash
set -e

sdir="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
source "${sdir}/parse_options" $*

# We assume the build user is already authenticated.
docker push ${IMAGE}:${VERSION}

ichar=$(echo "${VERSION}" | cut -c 1)
itype=""
case $ichar in
"r")
    itype="release"
    ;;
"w")
    itype="weekly"
    ;;
"d")
    itype="daily"
    ;;
*)
    ;;
esac
if [ -n "$itype" ]; then
    docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest_${itype}
    docker push ${IMAGE}:latest_${itype}
    # "latest" should always be the latest _weekly_
    if [ "${itype}" = "weekly" ]; then
      docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
      docker push ${IMAGE}:latest
    fi
fi
